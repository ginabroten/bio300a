---
title: "Lakselus og Infeksiøs lakseanemi (ILA)"
format: html
editor: visual
---

## Grafisk fremstilling av forekomst av ILA og tiltak for fjerning av lakselus

```{r}
#| label: setup of needed packagea
#| message: false
library(tidyverse)
library(readr)
library(dplyr)
library(tidyr)
library(gt)
```

### Grafisk fremstilling av forekomsten av ILA per produksjonsområde

```{r}
#| label: lager graf for ila
#| message: false

ila_import <- read_delim("ila_pd.csv", delim = ";") #importerer ila-data 

ila_sorted <- ila_import |> 
  filter(Sykdom == "ILA") #sorterer slik at vi kun får data om ila


ila_sorted$ProduksjonsområdeId <- factor(ila_sorted$ProduksjonsområdeId, levels = 1:12) #konverterer til faktorer, ettersom fra produksjonsområdene er det ikke rapportert noe fra 1


ila_clean <- ila_sorted[!is.na(ila_sorted$ProduksjonsområdeId), ] #fjerner NA-verdier


ila_clean |> 
  ggplot(aes(x = ProduksjonsområdeId, fill = Status)) + 
  geom_bar(position = "stack") +
  scale_x_discrete(drop = FALSE, expand = expansion(mult = c(0, 0))) +  
  labs(x = "Produksjonsområde ID", y = "Antall rapporterte tilfeller pr. fisk", fill = "Status") +
  theme_minimal()

```

### Grafisk fremstilling av tiltak for fjerning av lakselus per produksjonsområde

```{r}
#| label: graf av lakselus
#| message: false
#datene er konvertert til csv og importert med read_delim
lakselus <- read_delim("tiltak_mot_lakselus.csv", delim = ",")

lakselus$ProduksjonsområdeId <- factor(lakselus$ProduksjonsområdeId, levels = 1:12)

lakselus_clean <- lakselus |> 
  filter(!is.na(ProduksjonsområdeId), !is.na(Tiltak)) #filtrerer ut NA

#plotter fragen
lakselus_clean |> 
  ggplot(aes(x = ProduksjonsområdeId, fill = Tiltak)) + 
  geom_bar(position = "stack") +
  scale_x_discrete(drop = FALSE, expand = expansion(mult = c(0, 0))) +  
  labs(x = "Produksjonsområde ID", y = "Antall tiltak pr. fisk", fill = "Tiltak") +
  theme_minimal()


```

Prøver å kombinere de to datasettene for å få grafene på siden av hverandre - for å enklere kunne se korrelasjonen.

```{r}
#| label: grafene stilles opp mot hverandre
#| message: false


ila_data <- ila_clean |> 
  select(ProduksjonsområdeId, Status)

lakselus_data <- lakselus_clean |> 
  select(ProduksjonsområdeId, Tiltak) #nye datarammer

ila_data <- ila_data |> 
  mutate(Type = "Status for ILA", Combined = paste("Status - ", Status))  

lakselus_data <- lakselus_data |> 
  mutate(Type = "Tiltak mot lakselus", Combined = paste("Tiltak - ", Tiltak))  


combined_data <- bind_rows(ila_data, lakselus_data)


combined_graph <- combined_data |> 
  ggplot(aes(x = ProduksjonsområdeId, fill = Combined)) + 
  geom_bar(position = "stack") +
  scale_x_discrete(drop = FALSE, expand = expansion(mult = c(0, 0))) +  
  labs(x = "Produksjonsområde ID", y = "Antall rapporterte tilfeller / tiltak", fill = "Kategori") +
  theme_minimal() +
  facet_wrap(~ Type, scales = "free_y") +  
  theme(strip.text = element_text(size = 14, face = "bold"))  

# Vis grafen
print(combined_graph)

```

### Tabell som viser antall tiltak for å fjerne lakselus per produksjonsområdeID

```{r}
#| label: lager tabell for lakselus
#| message: false

lakselus_summary <- lakselus_clean |> 
  group_by(ProduksjonsområdeId, Tiltak) |> 
  summarise(Antall = n(), .groups = "drop") |> 
  complete(ProduksjonsområdeId = factor(1:12), Tiltak, fill = list(Antall = 0))

lakselus_wider <- lakselus_summary |> 
  pivot_wider(names_from = Tiltak, values_from = Antall, values_fill = 0)


lakselus_wider |> 
  gt() |> 
  tab_header(
    title = "Antall tiltak for å fjerne lakselus per produksjonsområdeID"
  ) |> 
  cols_label(
    ProduksjonsområdeId = "Produksjonsområde ID",            
    `mekanisk fjerning` = "Mekanisk fjerning",               
    medikamentell = "Medikamentell fjerning",                
    rensefisk = "Fjerning med rensefisk" )

```

### Tabell som viser de ulike rapportere statusene av ILA per produksjonsområde

```{r}
#| label:  lager tabell med ila
#| message: false

ila_summary <- ila_sorted |> 
  group_by(ProduksjonsområdeId, Status) |> 
  summarise(Antall = n(), .groups = "drop") |> 
  complete(ProduksjonsområdeId = factor(1:12), Status, fill = list(Antall = 0))



ila_pivot <- ila_summary |> 
  pivot_wider(names_from = Status, values_from = Antall, values_fill = 0)

ila_pivot |> 
  gt() |> 
  tab_header(
    title = "Antall rapporterte tilfeller av infeksiøs lakseanemi (ILA) per produksjonsområde ID"
  ) |> 
  cols_label(
    ProduksjonsområdeId = "ProduksjonsområdeID",
    Påvist = "Påvist ILA",
    Mistanke = "Mistanke om ILA",
    Avsluttet = "Asluttet behandling av ILA"
  )
```

### Antall unike lokalitetsnumre per produksjonsområde per datasett

```{r}
#| label: finner unike lokalitesnumre
#| message: false

# Telle antall unike lokalitetsnumre per produksjonsområde
ant_lokalitetsnummerila <- ila_sorted |> 
  group_by(ProduksjonsområdeId) |> 
  summarise(AntallLokaliteter = n_distinct(Lokalitetsnummer)) |> 
  arrange(ProduksjonsområdeId)

#i ila-datasettet eksisrerer det to påvist/avsluttet som ikke er knyttet til et produksjonsområd. Jeg velger å ikke bruke disse da de ikke er tilknyttet produksjonsområdeID


ant_lokalitetsnummerlakselus <- lakselus_clean |> 
  group_by(ProduksjonsområdeId) |> 
  summarise(AntallLokaliteter = n_distinct(Lokalitetsnummer)) |> 
  arrange(ProduksjonsområdeId)


ant_lokalitetsnummerila |> 
  ggplot(aes(x = ProduksjonsområdeId, y = AntallLokaliteter)) +
  geom_col() +
  theme_minimal()+
  labs(title = "Antall unike produksjonsområder per ProduksjonsområdeID i ILA-datasett",
    x = "ProduksjonsområdeID", y = "Antall lokaliteter")

ant_lokalitetsnummerlakselus |> 
  ggplot(aes(x = ProduksjonsområdeId, y = AntallLokaliteter)) +
  geom_col() +
  theme_minimal()+
  labs(title = "Antall unike produksjonsområder per ProduksjonsområdeID i lakselus-datasett",
    x = "ProduksjonsområdeID", y = "Antall lokaliteter")
```

For begge tabellene hadde det vært interessant å regnet ut antall tilfeller av ILA totalt, delt på antall tilfeller i hver produksjonsområde opp mot antall unike lokalitetsnumre? Videre gjøre noe av det samme med å dele antall påviste tilfeller av lakselus og dele opp mot antall per produksjonsområde




### Regner ut på lakselus datasett

```{r}
#| label: regner ut prosentvis informasjon opp mot lokalitetsnumre lakselus
#| message: false
sum_fjerning <- lakselus_summary |> 
  summarise(total_fjerning = sum(Antall)) #sum totale tiltak

sum_fjerning_pr_id <- lakselus_summary |> 
  group_by(ProduksjonsområdeId) |> 
  summarise(total_fjerning_pr_id = sum(Antall), .groups = "drop")  #summering av tiltak per produksjonsområde ID


total_fjerning <- sum_fjerning_pr_id |> 
  mutate(percentage = (total_fjerning_pr_id / sum_fjerning$total_fjerning) * 100)  #prosentberegning

total_fjerning_with_lokaliteter <- total_fjerning |> 
  left_join(ant_lokalitetsnummerlakselus, by = "ProduksjonsområdeId")

total_fjerning_with_lokaliteter |> 
  gt() |> 
   tab_header(
    title = "Antalle tiltak  per produksjonsområde ID og antall lokaliteter per produksjonsområde ID"
  ) |> 
  cols_label(
    ProduksjonsområdeId = "Produksjonsområde ID",
    total_fjerning_pr_id = "Antall tiltak",
    percentage = "Prosent tiltak ",
    AntallLokaliteter = "Antall lokaliteter i produksjonsområde"
  )
```

### Regner ut på ILA datasett

```{r}
#| label: regner ut prosentvis informasjon opp mot lokalitetsnumre ila
#| message: false
#| 
# Summere totale positive statuser
sum_positiv <- ila_pivot |> 
  summarise(total_positiv = sum(Påvist))


#sum av toale positve per produksjonsområde
sum_positiv_pr_id <- ila_sorted |> 
  group_by(ProduksjonsområdeId) |> 
  summarise(total_positiv_pr_id =  sum(Status == "Påvist"), .groups = "drop")

# Beregn prosentandel av positive statuser per produksjonsområde
total_positiv <- sum_positiv_pr_id |> 
  mutate(percentage = (total_positiv_pr_id / sum_positiv$total_positiv) * 100)

total_positiv_med_lokaliteter <- total_positiv |> 
  left_join(ant_lokalitetsnummerila, by = "ProduksjonsområdeId") |> 
  drop_na()

total_positiv_med_lokaliteter |> 
  gt() |> 
  tab_header(
    title = "Antalle påviste tilfeller per produksjonsområde ID og antall lokaliteter per produksjonsområde ID"
  ) |> 
  cols_label(
    ProduksjonsområdeId = "Produksjonsområde ID",
    total_positiv_pr_id = "Antall påviste tilfeller med ILA",
    percentage = "Prosent tilfeller med ILA ",
    AntallLokaliteter = "Antall lokaliteter i produksjonsområde"
  )
            
```

```{r}
#| label: kombinerer alt i samme tabell
#| message: false


combined_data <- total_fjerning_with_lokaliteter |> 
  full_join(total_positiv_med_lokaliteter, by = "ProduksjonsområdeId") #kombinerer datasettene


combined_data |> 
  gt() |> 
  tab_header(
    title = "Number of cases of ILA and efforts to remove salmonlice per production ID"
  ) |> 
  cols_label(
    ProduksjonsområdeId = "Production area ID",
    total_fjerning_pr_id = "Number of efforts made for salmon lice",
    percentage.x = "% of efforts",
    AntallLokaliteter.x = "Number of uniqe locations (salmon lice)",
    total_positiv_pr_id = "Number of positive cases of ILA",
    percentage.y = "% cases ofILA",
    AntallLokaliteter.y = "Number of unique locations (ILA)"
  )

```

```{r}
#| label: tabell med de unike lokalsjonsnumrene per produksjonsområde id
#| message: false
lokalitetsnummer_joined <- ant_lokalitetsnummerlakselus |> 
  left_join(ant_lokalitetsnummerila, by ="ProduksjonsområdeId")

lokalitetsnummer_joined |> 
  gt() |> 
  tab_header(
    title = "Number of uniqe localites per production area"
  ) |> 
  cols_label(
    ProduksjonsområdeId = "Production area ID",
    AntallLokaliteter.x = "Number of uniqe localities in the lice-dataset",
    AntallLokaliteter.y = "Number of unique localiteis in the ILA-dataset"
  )
```

```{r}
#| label: prosentvis andel av de ulike metodene for fjerning av lakselus
#| message: false

prosent_lakselus <- lakselus_wider |> 
  left_join(sum_fjerning_pr_id, by = "ProduksjonsområdeId")

prosentvis_lakselus <- prosent_lakselus |> 
  mutate(medikamentell = (medikamentell / total_fjerning_pr_id) * 100) |> 
  mutate(`mekanisk fjerning` = (`mekanisk fjerning` / total_fjerning_pr_id) * 100) |> 
  mutate(rensefisk = (rensefisk / total_fjerning_pr_id) * 100)

prosentvis_lakselus |> 
  gt() |> 
  tab_header(
    title = "Percentage of the different methos used to remove salmonlice"
  )


  
```





```{r}


#| label: prosentvis andel av de ulike metodene for fjerning av lakselus pluss isa data
#| message: false


prosentfordeling <- prosentvis_lakselus |> 
  left_join(total_positiv_med_lokaliteter, by = "ProduksjonsområdeId")



prosentfordeling |> 
  mutate(positiv_pr_uniklokasjon = (AntallLokaliteter / total_positiv_pr_id ) * 100) 
#syns ved kun legge til de positive ikke gir et godt bilde - min ide er å dele antallet positive på antall lokasjoner? kansje det kan gi et bedre bilde? 


prosentfordeling |> 
  gt() |> 
  tab_header(
    title = "Percentage of the different methods to remove salmon louse and the prevalence of ISA per production area ID and location"
  ) |> 
  cols_label(
    ProduksjonsområdeId = "Production ID",
    medikamentell = "% medicinal removal",
    `mekanisk fjerning` = "% mechanical removal",
    rensefisk = "% cleaner fish",
    total_fjerning_pr_id = "Number of removals",
    total_positiv_pr_id = "Positive cases of ISA",
    percentage = "% of ISA",
    AntallLokaliteter = "Uniqe locations"
  )


```

